#!/bin/bash
# Quick status check script

echo "=============================================="
echo "üîç TopoFlow Debug - Quick Status Check"
echo "=============================================="
echo "Time: $(date)"
echo ""

echo "üìã YOUR ACTIVE JOBS:"
echo "---"
squeue -u $USER || echo "No jobs in queue"
echo ""

echo "üìä RECENT JOB HISTORY (last 5):"
echo "---"
sacct --starttime=$(date -d '1 day ago' +%Y-%m-%d) --format=JobID,JobName,State,Elapsed,ExitCode -n | grep -E "topoflow|test_ven" | tail -5
echo ""

echo "=============================================="
echo "üß™ TEST JOB 13589754 (Venv Diagnostic - 4 GPUs)"
echo "=============================================="
if [ -f logs/test_venv_13589754.out ]; then
    echo "‚úÖ OUTPUT LOG EXISTS:"
    cat logs/test_venv_13589754.out
    echo ""
    if grep -q "ALL TESTS PASSED" logs/test_venv_13589754.out; then
        echo "‚úÖ‚úÖ‚úÖ VENV TEST PASSED! Venv propagation works!"
    elif grep -q "FAILED" logs/test_venv_13589754.out; then
        echo "‚ùå VENV TEST FAILED - Check errors above"
    fi
else
    echo "‚è≥ Log not created yet (job pending or just started)"
fi
echo ""

echo "=============================================="
echo "üöÄ MAIN TEST JOB 13589032 (32 GPUs)"
echo "=============================================="
if [ -f logs/topoflow_full_finetune_13589032.err ]; then
    ERR_LINES=$(wc -l < logs/topoflow_full_finetune_13589032.err)
    echo "üìÑ Error log: $ERR_LINES lines"
    echo ""

    if grep -q "LOCAL_RANK.*CUDA_VISIBLE_DEVICES" logs/topoflow_full_finetune_13589032.err; then
        echo "‚úÖ‚úÖ‚úÖ PYTHON STARTED! Job is running!"
        echo ""
        echo "Latest logs:"
        tail -30 logs/topoflow_full_finetune_13589032.err | grep -v amdgpu
    elif grep -q "All distributed processes registered" logs/topoflow_full_finetune_13589032.err; then
        echo "‚ö†Ô∏è  Distributed init done, checking if Python started..."
        echo ""
        echo "Last 20 lines (without amdgpu spam):"
        tail -50 logs/topoflow_full_finetune_13589032.err | grep -v amdgpu | tail -20
        echo ""
        STUCK_TIME=$((ERR_LINES / 40))  # Rough estimate: 40 lines per minute
        if [ $STUCK_TIME -gt 5 ]; then
            echo "‚ùå LIKELY STUCK - No progress for ~$STUCK_TIME minutes after DDP init"
        fi
    else
        echo "üîÑ Still initializing distributed processes..."
        tail -10 logs/topoflow_full_finetune_13589032.err | grep -v amdgpu
    fi
else
    echo "‚è≥ Log not created yet (job pending or just started)"
fi

echo ""
echo "=============================================="
echo "üìà AUTO-MONITOR LOG"
echo "=============================================="
if [ -f AUTO_MONITOR_13589032.log ]; then
    echo "Last 15 lines:"
    tail -15 AUTO_MONITOR_13589032.log
else
    echo "Auto-monitor not started or log not found"
fi

echo ""
echo "=============================================="
echo "üìù QUICK ACTION GUIDE"
echo "=============================================="
echo ""
echo "If VENV TEST PASSED + MAIN TEST shows LOCAL_RANK messages:"
echo "  ‚úÖ SUCCESS! Python is starting correctly"
echo "  ‚Üí Edit submit_multipollutants_from_6pollutants.sh"
echo "  ‚Üí Change to 16 nodes (128 GPUs)"
echo "  ‚Üí sbatch submit_multipollutants_from_6pollutants.sh"
echo ""
echo "If VENV TEST PASSED but MAIN TEST stuck:"
echo "  ‚Üí Problem is scale-dependent"
echo "  ‚Üí Try 8 nodes (64 GPUs) first"
echo ""
echo "If VENV TEST FAILED:"
echo "  ‚Üí Venv propagation is broken"
echo "  ‚Üí Check test_venv logs for error details"
echo "  ‚Üí May need Singularity container"
echo ""
echo "If both jobs still PENDING:"
echo "  ‚Üí Just wait, they're in the queue"
echo "  ‚Üí Run this script again in 10-15 minutes"
echo ""

echo "=============================================="
echo "For full details, read: STATUS_WHEN_YOU_WAKE_UP.md"
echo "=============================================="
