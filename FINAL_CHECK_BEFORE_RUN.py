"""
V√âRIFICATION FINALE: Tout est-il OK pour le job 13640655?
"""
import sys
sys.path.insert(0, 'src')
import yaml

print("="*100)
print("üîç V√âRIFICATION FINALE AVANT LE JOB 13640655")
print("="*100)

# 1. Config
print("\n1Ô∏è‚É£ CONFIGURATION:")
with open('configs/config_all_pollutants.yaml', 'r') as f:
    config = yaml.safe_load(f)

print(f"   TopoFlow (use_physics_mask): {config['model'].get('use_physics_mask', False)}")
print(f"   Wind scanning: {config['model'].get('parallel_patch_embed', False)}")
print(f"   Checkpoint: {config['model'].get('checkpoint_path', 'None')}")
print(f"   Learning rate: {config['train']['learning_rate']}")
print(f"   Batch size: {config['train']['batch_size']}")
print(f"   Accumulate grad batches: {config['train']['accumulate_grad_batches']}")

# 2. Dataloader
print("\n2Ô∏è‚É£ DATALOADER:")
try:
    from dataloader import PM25AirQualityDataset
    print(f"   ‚úÖ Utilise PM25AirQualityDataset (septembre 2024)")
    print(f"   ‚úÖ Normalisation dynamique √† la vol√©e")
except ImportError as e:
    print(f"   ‚ùå Erreur import: {e}")
    sys.exit(1)

# 3. Test dataloader
print("\n3Ô∏è‚É£ TEST DATALOADER:")
try:
    from datamodule import AQNetDataModule
    dm = AQNetDataModule(config)
    print(f"   ‚úÖ DataModule cr√©√© avec succ√®s")
except Exception as e:
    print(f"   ‚ùå Erreur cr√©ation DataModule: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# 4. Model
print("\n4Ô∏è‚É£ MOD√àLE:")
try:
    from model_multipollutants import MultiPollutantLightningModule
    model = MultiPollutantLightningModule(config=config)
    print(f"   ‚úÖ LightningModule cr√©√© avec succ√®s")
except Exception as e:
    print(f"   ‚ùå Erreur cr√©ation mod√®le: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# 5. Checkpoint loading
print("\n5Ô∏è‚É£ CHARGEMENT CHECKPOINT:")
import torch
ckpt_path = config['model']['checkpoint_path']
try:
    ckpt = torch.load(ckpt_path, map_location='cpu', weights_only=False)
    print(f"   ‚úÖ Checkpoint charg√©: {len(ckpt['state_dict'])} cl√©s")
    print(f"   Epoch: {ckpt.get('epoch', 'N/A')}")
    print(f"   Global step: {ckpt.get('global_step', 'N/A')}")
except Exception as e:
    print(f"   ‚ùå Erreur chargement checkpoint: {e}")
    sys.exit(1)

print("\n" + "="*100)
print("üìä R√âSUM√â:")
print("="*100)
print("‚úÖ Configuration: OK")
print("‚úÖ Dataloader septembre 2024: OK")
print("‚úÖ DataModule: OK")
print("‚úÖ Mod√®le: OK")
print("‚úÖ Checkpoint: OK")
print("")
print("üöÄ TOUT EST PR√äT POUR LE JOB 13640655!")
print("="*100)
