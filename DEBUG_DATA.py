#!/usr/bin/env python3
"""VÃ©rifier les stats des donnÃ©es - normalisation a peut-Ãªtre changÃ©"""
import torch
import sys
sys.path.insert(0, '/scratch/project_462000640/ammar/aq_net2')

from src.config_manager import ConfigManager
from src.datamodule_fixed import AQNetDataModule

config_path = "/scratch/project_462000640/ammar/aq_net2/configs/config_all_pollutants.yaml"
cfg_mgr = ConfigManager(config_path)
config = cfg_mgr.config
config['data']['num_workers'] = 0

print("="*100)
print("VÃ‰RIFICATION STATS DES DONNÃ‰ES")
print("="*100)

data_module = AQNetDataModule(config)
data_module.setup('fit')
train_loader = data_module.train_dataloader()

# Prendre 1 batch
batch = next(iter(train_loader))

if len(batch) == 3:
    x, y, lead_times = batch
elif len(batch) == 4:
    x, y, lead_times, variables = batch
else:
    x, y, lead_times, variables, _ = batch

print(f"\nðŸ“Š BATCH INFO:")
print(f"   Input shape:  {x.shape}")
print(f"   Target shape: {y.shape}")
print(f"   Input dtype:  {x.dtype}")
print(f"   Target dtype: {y.dtype}")

print(f"\nðŸ“Š INPUT STATISTICS (X):")
print(f"   Mean: {x.mean().item():.6f}")
print(f"   Std:  {x.std().item():.6f}")
print(f"   Min:  {x.min().item():.6f}")
print(f"   Max:  {x.max().item():.6f}")

print(f"\nðŸ“Š TARGET STATISTICS (Y):")
print(f"   Mean: {y.mean().item():.6f}")
print(f"   Std:  {y.std().item():.6f}")
print(f"   Min:  {y.min().item():.6f}")
print(f"   Max:  {y.max().item():.6f}")

# Check par variable
print(f"\nðŸ“Š TARGET PAR POLLUANT:")
target_vars = config['data']['target_variables']
for i, name in enumerate(target_vars):
    if i < y.shape[1]:
        y_i = y[:, i]
        print(f"   {name:6s}: mean={y_i.mean().item():8.4f}, std={y_i.std().item():7.4f}, min={y_i.min().item():8.4f}, max={y_i.max().item():8.4f}")

print("\n" + "="*100)
print("ðŸ’¡ ANALYSE:")
print("   Si mean/std sont trÃ¨s diffÃ©rents de 0/1, il y a peut-Ãªtre un problÃ¨me de normalisation")
print("   Si min/max contiennent des valeurs extrÃªmes, Ã§a peut causer une loss Ã©levÃ©e")
print("="*100)
